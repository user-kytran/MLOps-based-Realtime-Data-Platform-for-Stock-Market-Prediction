ğŸ‰ HOÃ€N Táº¤T CÃ€I Äáº¶T STOCK CDC LATENCY MONITORING
================================================

âœ… ÄÃƒ CÃ€I Äáº¶T THÃ€NH CÃ”NG

1. Backend Metrics:
   - ÄÃ£ cÃ i prometheus-client
   - Endpoint: http://localhost:8005/stocks/metrics
   - Metrics: cdc_latency_ms, cdc_events_total, cdc_active_connections

2. Prometheus:
   - Target stock_backend: UP
   - Scrape interval: 5s
   - URL: http://localhost:9090

3. Grafana:
   - Dashboard: Stock CDC Latency Monitoring
   - URL: http://localhost:3000
   - Login: Anonymous (admin role)

ğŸ“Š XEM DASHBOARD

1. Truy cáº­p: http://localhost:3000
2. VÃ o menu Dashboards (â˜°)
3. TÃ¬m folder "Stock Monitoring" â†’ "Stock CDC Latency Monitoring"
4. Hoáº·c search "stock"

HIá»†N Táº I: Dashboard chÆ°a cÃ³ data vÃ¬ chÆ°a cÃ³ CDC events
â†’ Cáº§n cÃ³ WebSocket connections vÃ  CDC stream data thÃ¬ metrics má»›i cÃ³ giÃ¡ trá»‹

ğŸ” KIá»‚M TRA Há»† THá»NG

# 1. Test metrics endpoint
curl http://localhost:8005/stocks/metrics | grep cdc

# 2. Xem Prometheus targets  
http://localhost:9090/targets
â†’ TÃ¬m "stock_backend" â†’ Status pháº£i lÃ  "UP"

# 3. Query metrics
http://localhost:9090/graph
â†’ GÃµ: cdc_active_connections
â†’ Execute

# 4. Xem Grafana dashboard
http://localhost:3000
â†’ VÃ o folder "Stock Monitoring"
â†’ Click "Stock CDC Latency Monitoring"

ğŸš€ LÃ€M SAO Äá»‚ CÃ“ Dá»® LIá»†U?

Metrics sáº½ cÃ³ data khi:
1. WebSocket client káº¿t ná»‘i: ws://localhost:8005/ws/stocks_realtime
2. CDC consumer nháº­n events tá»« Scylla
3. Producer gá»­i data vá»›i producer_timestamp
4. Latency = t3 - producer_timestamp Ä‘Æ°á»£c tÃ­nh

ğŸ“ˆ CÃC PANEL TRONG DASHBOARD

1. CDC Latency Percentiles - P50/P95/P99 theo thá»i gian
2. CDC Latency P95 by Symbol - Latency tá»«ng mÃ£ chá»©ng khoÃ¡n
3. Current P95 Latency - Gauge hiá»‡n táº¡i
4. Active WebSocket Connections - Sá»‘ connections
5. CDC Events Rate - Events/giÃ¢y
6. CDC Stats by Symbol - Báº£ng tá»•ng há»£p

ğŸ”§ Náº¾U Cáº¦N RESTART

cd /home/obito/main/scylla-monitoring
./restart-with-stock.sh

Hoáº·c thá»§ cÃ´ng:
./kill-all.sh
./start-all.sh -v 5.2 -d prometheus_data -D "--network=financi-network -e TZ=Asia/Ho_Chi_Minh" -s ./prometheus/scylla_servers.yml -c "TZ=Asia/Ho_Chi_Minh" -c "GF_DATE_FORMATS_DEFAULT_TIMEZONE=Asia/Ho_Chi_Minh" --auto-restart --no-alertmanager --no-loki --no-renderer

ğŸ› DEBUG

# Backend logs
docker logs webstock-backend | tail -50

# Prometheus logs  
docker logs aprom | tail -50

# Test WebSocket connection
wscat -c ws://localhost:8005/ws/stocks_realtime

# Xem CDC consumer Ä‘ang cháº¡y
docker logs webstock-backend | grep CDC

ğŸ“ FILES ÄÃƒ CHá»ˆNH Sá»¬A

1. web-stockAI/backend/requirements.txt - ThÃªm prometheus-client
2. web-stockAI/backend/src/api/routers/stocks.py - ThÃªm metrics
3. scylla-monitoring/prometheus/prometheus.yml.template - ThÃªm job
4. scylla-monitoring/grafana/build/stock-cdc-latency.json - Dashboard

âœ¨ XONG! Há»† THá»NG ÄÃƒ Sáº´N SÃ€NG MONITOR CDC LATENCY!

